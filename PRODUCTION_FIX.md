# 生产环境数据库存储修复

## 问题描述

在生产环境中（如 AWS Lambda、Vercel 等 serverless 环境），文件系统是只读的，无法创建新的目录。当应用尝试在 `/var/task/data` 目录下创建文件夹时，会抛出 `ENOENT: no such file or directory` 错误。

## 解决方案

修改了 `utils/database.ts` 文件，实现了智能存储模式切换：

### 1. 环境检测

- 自动检测是否为生产环境 (`NODE_ENV === 'production'`)
- 检测是否为 serverless 环境 (AWS Lambda、Vercel、Netlify)
- 测试文件系统写入权限

### 2. 存储模式

- **开发环境**: 优先使用文件系统存储 (`data/users.json`, `data/history.json`)
- **生产环境/Serverless**: 自动切换到内存存储
- **降级机制**: 如果文件系统不可用，自动切换到内存存储

### 3. 数据持久性

- **开发环境**: 数据持久化到文件系统
- **生产环境**: 数据存储在内存中（重启后丢失）
- **建议**: 生产环境应使用外部数据库（如 Redis、MongoDB、PostgreSQL）

## 修改内容

### 新增功能

1. 环境检测逻辑
2. 文件系统权限测试
3. 内存存储变量
4. 智能存储模式切换

### 修改的方法

- `getUsers()`: 根据环境选择存储方式
- `saveUsers()`: 根据环境选择存储方式
- `getHistory()`: 根据环境选择存储方式
- `saveHistory()`: 根据环境选择存储方式

## 使用说明

### 开发环境

```bash
npm run dev
```

- 自动使用文件系统存储
- 数据持久化到 `data/` 目录

### 生产环境

```bash
npm run build
npm run preview
```

- 自动检测环境并切换到内存存储
- 无需额外配置

## 注意事项

1. **数据持久性**: 生产环境使用内存存储，重启后数据会丢失
2. **扩展性**: 内存存储不适合高并发场景
3. **建议**: 生产环境应集成外部数据库

## 后续优化建议

1. 集成 Redis 作为生产环境存储
2. 添加数据库连接池
3. 实现数据备份和恢复机制
4. 添加数据迁移工具
